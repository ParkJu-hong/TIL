[AWS 공부해야할 것](https://www.notion.so/AWS-ca4aa0315f894e8fa15ea09933809d00)
## PW2

for commit

프로세스(실행 중인 프로그램, 컴퓨터 프로그램의 인스턴스) 보는 법

- 같은 프로그램을 여러개 실행하는 경우, 여러개의 프로세스가 존재함을 확인 할 수 있음
- 리눅스 ⇒ "ps"명령어
- 활성 상태 보기 ⇒ mac

ssh에서 EC2 접속 후 강제 종료를 하게되면 로컬의 ssh프로세스가 강제 종료되고, ssh프로세스가 종료되면 EC2상의 node 프로세스가 강제 종료된다. node프로세스가 강제종료되면, node로 작동중인 웹 서버가 종료되므로..

```jsx
백그라운드 실행(linux/unix)

command &
ex) node index.js
fg 포어 그라운드로 불러옴
kill 프로세스 강제 종료
```

이런 명령어 대신에 프로세스를 관리해 주는 프로그램이 PM2다.

PM2는 node.js로 실행되는 프로그램(프로세스)를 관리해주며, 백그라운드에서 실행되게 만들 수 있음

 단순히 백그라운드 실행뿐만 아니라 슬라이드에 언급된 것처럼, 다양하고 강력한 기능을 제공합니다.

이중 Hot Reload와 같이 프로그램이 변경될 때 자동으로 재시작하게 도와준다거나, 프로그램 실행 중 에러가 나서 서버가 종료되면, 다시 자동으로 실행시켜주는 기능을 제공합니다.
또한, 서버 운영에서는 필수라고 할 수 있는 로그 관리를 좀 더 전문적으로 할 수 있습니다.
클러스터 모드와 같이 멀티코어 CPU를 최대한 활용하는 옵션도 있습니다.

### PW2 설치방법

1) npm install pm2 -g

2)

pm2를 설치한 후에 pm2 start app.js 라는 명령어를 사용하면 에러가 나온다 이는

서버를 실행시킬 경우 관리자 권한으로 pm2가 프로세스를 실행해야하는 데, 그러질 못하는 것이다.

pm2에 관리자 권환을 부여하기 위해서는 'authbind'라는 패키지를 추가 설치해야한다.

```jsx
터미널에서 아래 명령어를 차례대로 입력하여 authbind를 설치합니다.

sudo apt-get update

sudo apt-get install authbind

sudo touch /etc/authbind/byport/80

sudo chown ubuntu /etc/authbind/byport/80

sudo chmod 755 /etc/authbind/byport/80

authbind --deep pm2 update

authbind의 설치를 완료한 뒤, 먼저 'pm2 ls' 명령어를 통해 어떤 프로그램이 PM2의 프로세스 리스트에 등록되어 있는지 확인합니다.

'app' 프로세스가 리스트에 있다면 'pm2 delete app.js' 명령어를 통해 프로세스를 삭제합니다. authbind 설치 전에 실행되고 있던 프로세스에는 관리자 권한을 부여하지 못하기 때문입니다.

PM2에 관리자 권한을 부여하기 위해서는 'authbind --deep' 명령어를 앞에 추가해야 합니다.

 'authbind --deep pm2 start app.js' 명령어를 통해 서버를 다시 실행하면 이번에는 문제없이 작동할 것입니다.
```

3 ) 사용방법

```jsx
"pm2 stop" 프로세스 중지
"pm2 restart"  프로세스 재시작
"pm2 ls"   프로세스 목록 보기
"pm2 log" 프로세스 로그 보기
```

# S3(Simple Storage Service)로 정적 웹 페이지 호스팅하는 법

S3의 데이터를 외부로 노출하지 않으려면 퍼블릭 액세스 차단을 활성화해야 한다.

S3 버킷을 정적 웹사이트 호스팅 기능을 활성화해서 웹에서 접근 가능하게 만들었습니다. 그런데, 브라우저를 통해 해당 URL에 접근하려고 하니 403 Forbidden 에러가 발생했습니다. 문제에 대한 해결 방법으로 적절한 것을 고르면?

**정답**A.
해당 버킷에 대한 모든 퍼블릭 액세스 차단을 비활성화한다

버킷 정책에 업데이트해야 할 권한은 PutObject가 아닌, GetObject이다.

참고: 퍼블릭 액세스를 허용하기만 해도 URL로 접근은 가능하나, 읽기 액세스 설정을 하지 않으면, ACL을 통해 액세스를 허용하지 않은 객체의 경우 해당 객체를 읽을 수 없다.

버킷에 GetObject 권한 추가는, 모든 객체에 대한 권한 추가임 `"arn:aws:s3:::Bucket-Name/*"`

다음과 같은 객체 URL이 있을 때에, S3 기본 용어와 해당 객체에 대한 정보가 틀리게 짝지어진 것을 모두 고르면?

`https://practice-kimcoding.s3.ap-northeast-2.amazonaws.com/static/js/2aa43b.chunk.js`

키는

```
static/js/2aa43b.chunk.js
```

버킷은 practice-kimcoding 이다

김코딩은 S3에서 객체를 담기 위해 dev 란 이름의 버킷을 생성하려고 시도했으나, 에러가 나면서 실패했다. 참고로 김코딩은 AWS에 처음 가입한 사용자로, 이전에 그 어떤 버킷도 만든 적이 없었다. 어떤 문제가 발생한 것을까?

A.
S3 버킷을 생성할 IAM 권한을 받지 못했기 때문

**정답**B.
S3 버킷 이름은 국제적으로 고유한 것이어야 하는데, 이미 다른 사람이 사용하고 있기 때문

먼저 정적 웹 사이트를 호스팅하는 과정은 4 단계로 요약됩니다. 첫번째로 구현이 완성된 정적 웹 페이지를 빌드합니다.

빌드 과정이 끝나면 S3 대시보드에 접속하여 버킷을 생성하고, 생성한 버킷을 정적 웹 사이트 호스팅 용으로 구성합니다.

그 다음으로 빌드된 정적 웹 페이지를 버킷에 업로드합니다. 업로드가 완료되면 퍼블릭 액세스 차단 설정을 해제하고, 다른 사용자의 접근 권한을 부여하는 버킷 정책을 생성합니다.

모든 과정이 끝나면 다른 사용자들이 버킷에 업로드된 정적 웹 페이지에 접속할 수 있습니다.

먼저 정적 웹 페이지를 빌드하는 과정부터 시작하겠습니다.

먼저 '빌드(build)'에 대해 잠시 알아보는 시간을 가지겠습니다. 빌드란 작성한 코드의 불필요한 데이터를 없애고, 통합 및 압축하여 배포하기 이상적인 상태를 만드는 과정을 말합니다. 빌드 과정을 통하여 코드를 담고 있는 데이터의 용량이 줄어들고, 웹 사이트의 로딩 속도가 빨라집니다.

빌드하기에 앞서 환경 변수를 담은 .env 파일을 확인합니다. .env 파일의 파일명이 제대로 적혀있는지, 환경 변수에 담긴 서버의 주소는 문제가 없는지 확인합니다. 참고로 요청을 보내는 서버의 주소를 환경 변수에 담을 때는 필히 'http://' 나 'https://'를 포함해야 합니다.

환경 변수를 제대로 설정하지 않으면 서버에 요청을 제대로 보내지 못하게 되고, 그 결과로 정상적인 응답을 받아올 수 없습니다. 이 부분 주의하시고, 해당 과정이 끝나면 다음 슬라이드로 넘어갑니다.

환경 변수 관련 설정이 완료되면, 터미널에 'npm run build' 명령어를 입력하여 빌드 과정을 진행합니다. 얼마간에 시간이 지나면 터미널 화면에 'Compiled Successfully' 라는 문구가 보이며 빌드 과정이 마무리됩니다.

S3권한 들어갈때 버킷 정책

여기서 버킷 정책을 생성합니다.

'Select Type of Policy' 옵션에서는 'S3 Bucket Policy'를 선택합니다.

'Principal' 옵션은 권한을 적용할 사용자를 정합니다. 우리는 모두에게 공개할 것이므로 *(별표)를 입력합니다.

'Actions' 옵션에서는 'GetObject'를 선택합니다. GetObject 옵션을 선택하게 되면, 버킷에 접근하는 모든 사용자가 버킷 내에 저장된 객체 데이터를 읽을 수 있게 됩니다. 버킷을 웹 사이트 용도로 구성할 때 선택해주시면 좋습니다.

# RDS로 데이터베이스 연결하는 법

RDS 실습 과정을 전체적으로 간략하게 요약해보겠습니다. RDS를 실습하는 과정은 간단합니다.

먼저 MySQL 데이터베이스 엔진을 사용하는 DB 인스턴스를 생성한 뒤, 로컬 환경에서 MySQL 클라이언트를 활용하여 DB 인스턴스에 연결합니다.

AWS의 RDS로 들어간다

데이터베이스 클릭

데이터베이스 생성버튼 클릭

데이터베이스 엔진 옵션클릭 우선 실습으로 mysql선택

템플릿옵션 '프리티어'선택

연결옵션에서 식별자, 사용자 이름과 암호 기입

⇒ 설정 옵션 창으로 이동하여 DB 클러스터 식별자 이름, 마스터 사용자 이름과 마스터 암호를 기재합니다. 마스터 사용자 이름과 암호는 나중에 데이터베이스를 연결할 때 쓰이는 정보입니다. 반드시 기억해주세요

연결 옵션에서 '퍼블릭 액세스 가능' 부분 변경

⇒ 연결 옵션으로 이동하셔서 퍼블릭 액세스 가능 부분을 '예'로 설정합니다.

보안 그룹 확인 및 포트 번호 수정

⇒  보안 그룹 같은 경우는 기본값인 'default' 보안 그룹을 선택합니다. 다른 보안 그룹을 선택 시 로컬 환경 터미널에서 테스트가 불가능합니다.

'추가 연결 구성' 토글을 여시면 데이터베이스 포트 번호를 지정할 수 있는 창이 보이실 겁니다. 여기서는 흔히 사용되는 3306번 포트 대신, 포트번호 노출을 방지하려는 목적으로 13306번으로 지정합니다.

'추가 구성' 토글 열어서 초기 데이터베이스 이름 지정

⇒  포트 번호 변경이 완료된 뒤, 페이지의 스크롤을 아래로 내립니다. '추가 구성' 토글 창을 찾아 클릭합니다. 추가 구성 토글을 열면 여러 옵션을 추가로 확인 가능합니다.

여기서 우리는 초기 데이터베이스 'test' 라는 이름으로 설정합니다. 서버 코드가 'test' 데이터베이스를 찾도록 작성되어 있으니, 다른 이름은 사용하지 않습니다.

데이터베이스 생성

⇒ 초기 데이터베이스 이름을 기입하고 나면 모든 설정이 끝납니다. '데이터베이스 생성' 버튼을 클릭하여 DB 인스턴스를 생성합니다.

DB 인스턴스가 생성되기까지 시간이 오래 걸리기에 여기서 잠시 기다려주셔야 합니다. 슬라이드에서 확인할 수 있는 '상태' 부분이 현재 '생성 중'으로 보인다면 잠시 대기합니다.
이 부분이 '사용 가능'으로 변화하면 DB 인스턴스 생성이 완료됩니다.

다음으로 MySQL 클라이언트를 활용하여 DB 인스턴스에 연결하는 과정을 진행하겠습니다.

데이터 베이스 연결

엔드포인트 확인

⇒

MySQL 클라이언트를 통해 RDS의 DB 인스턴스에 연결하기 위해서는 세 가지 정보가 필요합니다.

1. DB 인스턴스 생성 시 기재한 마스터 이름, 마스터 비밀번호
2. 포트 번호
3. 생성한 DB 인스턴스의 엔드포인트 주소

여기서 포트 번호와 마스터 유저 정보 부분은 생성 과정에서 직접 기재했기 때문에 설명을 생략하도록 하겠습니다.
엔드포인트 주소를 확인하기 위해서 생성한 DB 인스턴스를 클릭합니다.

연결 & 보안 메뉴 부분을 보시면 엔드포인트 주소를 확인할 수 있습니다. 엔드포인트 주소를 복사하여 저장합니다.

터미널에서 MySQl 실행해서 연결

⇒ MySQL 을 통해서 DB 인스턴스에 접속합시다.

'mysql -u [마스터 이름] --host [엔드포인트 주소] -P 13306(포트번호) -p' 명령어를 입력하면 됩니다.

해당 명령어를 입력하면 비밀번호를 요구하는데, 마스터 비밀번호를 입력하면 됩니다.

정상적으로 진행이 된다면 슬라이드 화면과 같은 메시지가 뜨며 MySQL에 접속이 될 것입니다. 데이터베이스 연결 테스트를 하기 위해 터미널에 'show databases;' 를 입력합니다.

아까 DB 인스턴스를 생성할 때 만들었던 초기 데이터베이스 'test'가 보인다면 정상적으로 연결이 된 것입니다.

**[AWS] AWS VPC 사용설명서 정리**

[https://ch4njun.tistory.com/203](https://ch4njun.tistory.com/203)

# 서버 환경설정

# **서버 환경 설정**

소요시간 : 4 min

EC2 인스턴스에서 실행되고 있는 서버는, 그 자체로는 작동하고 있지만, 아직 데이터베이스에 연결하지는 않았습니다.

서버의 환경 설정을 통해 지난 실습에서 생성한 RDS 인스턴스에 접속하고, 클라우드 데이터베이스를 사용할 수 있게 해봅시다.

## **1. 서버 코드에 저장된 .env 파일에 환경 변수 설정하기**

EC2 인스턴스에서 실행하고 있는 서버를 종료합니다.

- PM2를 이용해 프로세스로 실행 중인 경우 `pm2 stop <id>`
- node나 npm 명령을 통해 서버를 실행한 경우  +

    Ctrl

    C


이제 환경 설정 파일을 수정해봅시다. 먼저 `.env.example`의 파일명을 `.env`로 바꿔줘야 합니다.

```
mv .env.example .env
```

터미널에서 스프린트 코드의 server 디렉토리로 이동한 뒤, nano를 통해 `.env`파일을 열어봅니다.

```
nano .env
```

.env 파일에는 아래와 같이 4개의 환경변수가 저장되어 있습니다. 각 환경 변수에 특정 값을 저장해주어야 합니다.

![https://s3.ap-northeast-2.amazonaws.com/urclass-images/vI0hvMJQa-1618493634428.png](https://s3.ap-northeast-2.amazonaws.com/urclass-images/vI0hvMJQa-1618493634428.png)

1. `DATABASE_HOST` 변수에는 생성한 DB 인스턴스의 엔드포인트 주소를 넣습니다.
2. `DATABASE_USER` 변수에는 마스터 사용자 이름을 넣습니다.
3. `DATABASE_PASSWORD` 변수에는 마스터 암호를 넣습니다.
4. `DATABASE_PORT` 에는 DB 인스턴스의 port 번호를 넣습니다.

위 스크린샷에 보이는 것처럼 환경 변수를 할당하는 과정이 끝나면, Ctrl + X 키를 입력하여 변경 내용을 저장합니다.

![https://s3.ap-northeast-2.amazonaws.com/urclass-images/HEBts3pE7-1618493961094.png](https://s3.ap-northeast-2.amazonaws.com/urclass-images/HEBts3pE7-1618493961094.png)

위와 같은 화면이 보이면 `y`를 입력하고 Enter 키를 통해 파일을 저장합니다.

`.env` 파일을 통한 환경 설정이 완료되면, 서버를 재실행합니다.

## **2. 서버 실행**

- `sudo npm start` 명령어를 입력하여 서버를 재실행합니다.
- PM2를 이용해서 프로세스로 실행할 수도 있습니다.
    - `authbind --deep pm2 stop app.js`명령어를 이용하여 프로세스를 정지합니다.
    - `authbind --deep pm2 start app.js`명령어를 이용하여 프로세스를 시작합니다.

서버를 실행하고 다시 s3 버킷의 엔드포인트 주소로 접속해서 연결 테스트를 진행합니다. 이름에 `김코딩` 을, 비밀번호에 `1234` 를 입력합니다.

![https://s3.ap-northeast-2.amazonaws.com/urclass-images/3nwwR96dB-1618494332980.png](https://s3.ap-northeast-2.amazonaws.com/urclass-images/3nwwR96dB-1618494332980.png)

아래와 같은 메세지가 화면에 보인다면 데이터베이스 연결에 성공한 것입니다.

![https://s3.ap-northeast-2.amazonaws.com/urclass-images/VJm6oOI7Z-1618494315919.png](https://s3.ap-northeast-2.amazonaws.com/urclass-images/VJm6oOI7Z-1618494315919.png)

## **뭔가 제대로 되고 있지 않아요!**

위 메세지가 보이지 않고 다른 메세지가 화면에 출력된다면 아래 사항을 체크해보세요.

1. DB 인스턴스가 정상적으로 실행되고 있나요?
2. 환경변수에 제대로 된 값을 할당하지 않았는지(DB 인스턴스의 엔드포인트 값을 환경 변수에 넣을 때, 앞에 `http://`를 붙이면 안 됩니다. 위 스크린샷의 예시를 참고해주세요)
3. `.env.example` 파일명이 `.env`로 정상적으로 변경되었는지 확인합니다.
4. 크롬 개발자 도구의 Network 탭에 들어가서 요청, 응답 과정에서 어떤 오류가 발생하는지 확인합니다.
